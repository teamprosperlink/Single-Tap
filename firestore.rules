rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================
    // HELPER FUNCTIONS
    // ============================================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if the user is the owner of the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if user is a participant in a conversation
    function isParticipant(conversationData) {
      return isAuthenticated() &&
        (request.auth.uid in conversationData.participants ||
         (conversationData.participantIds != null && request.auth.uid in conversationData.participantIds));
    }

    // Validate string length
    function isValidString(str, minLen, maxLen) {
      return str is string && str.size() >= minLen && str.size() <= maxLen;
    }

    // Check if user is admin of a group
    function isGroupAdmin(admins) {
      return isAuthenticated() && admins != null && request.auth.uid in admins;
    }

    // ============================================================
    // USERS COLLECTION
    // ============================================================
    match /users/{userId} {
      // Authenticated users can read full profiles (for discovery)
      // Unauthenticated users can read if document has device-related fields (needed for device session logout)
      allow read: if isAuthenticated() ||
                     (resource != null && (
                       resource.data.get('activeDeviceToken') != null ||  // Has device field
                       resource.data.get('forceLogout') != null ||         // Has logout flag
                       resource.data.get('deviceInfo') != null              // Has device info
                     ));

      // Only the user can create their own profile
      allow create: if isOwner(userId);

      // Owner can update, OR anyone (including unauthenticated) can update device-related fields only
      // (This is needed for SingleTap-style single device login: logout mechanism)
      // When Device B is signed out after collision, it needs to write the logout signal
      allow update: if isOwner(userId) ||
                       // Allow updating ONLY device fields (even unauthenticated)
                       // This enables Device B to send logout signal after being signed out
                       (request.resource.data.diff(resource.data).affectedKeys().hasOnly([
                         'activeDeviceToken',
                         'deviceName',
                         'deviceInfo',
                         'forceLogout',
                         'lastSessionUpdate'
                       ]));

      // Only owner can delete their profile
      allow delete: if isOwner(userId);

      // Private data subcollection
      match /private/{document=**} {
        allow read, write: if isOwner(userId);
      }

      // Blocked users subcollection
      match /blocked/{blockedUserId} {
        allow read, write: if isOwner(userId);
      }

      // Security events subcollection
      match /securityEvents/{eventId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if false; // Security events are immutable
      }

      // Cleared chats subcollection (for clear chat feature)
      match /clearedChats/{conversationId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ============================================================
    // POSTS COLLECTION (Main data for matching - Single source of truth)
    // ============================================================
    match /posts/{postId} {
      // Anyone authenticated can read active posts
      allow read: if isAuthenticated();

      // Only authenticated users can create posts with their own userId
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // Only the owner can update their posts
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // Only the owner can delete their posts
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // Comments subcollection
      match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() &&
          request.resource.data.userId == request.auth.uid;
        allow update, delete: if isAuthenticated() &&
          resource.data.userId == request.auth.uid;
      }

      // Likes subcollection
      match /likes/{likeId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && likeId == request.auth.uid;
      }
    }

    // ============================================================
    // CONVERSATIONS COLLECTION (Chats & Groups)
    // ============================================================
    match /conversations/{conversationId} {
      // Participants can read the conversation
      allow read: if isAuthenticated() &&
        (resource == null ||
         request.auth.uid in resource.data.participants ||
         (resource.data.participantIds != null && request.auth.uid in resource.data.participantIds));

      // Any authenticated user can create a conversation they're part of
      allow create: if isAuthenticated() &&
        (request.auth.uid in request.resource.data.participants ||
         (request.resource.data.participantIds != null && request.auth.uid in request.resource.data.participantIds));

      // Participants can update conversation metadata
      allow update: if isAuthenticated() &&
        (request.auth.uid in resource.data.participants ||
         (resource.data.participantIds != null && request.auth.uid in resource.data.participantIds));

      // Only participants can delete (archive) conversations
      // For groups, only admins can delete
      allow delete: if isAuthenticated() &&
        (request.auth.uid in resource.data.participants ||
         (resource.data.participantIds != null && request.auth.uid in resource.data.participantIds) ||
         (resource.data.isGroup == true && isGroupAdmin(resource.data.admins)));

      // Messages subcollection
      match /messages/{messageId} {
        // Participants can read messages
        allow read: if isAuthenticated() &&
          isParticipant(get(/databases/$(database)/documents/conversations/$(conversationId)).data);

        // Participants can create messages (sender must be themselves)
        allow create: if isAuthenticated() &&
          request.resource.data.senderId == request.auth.uid &&
          isParticipant(get(/databases/$(database)/documents/conversations/$(conversationId)).data);

        // Sender can update their own messages, or recipient can mark as read
        allow update: if isAuthenticated() &&
          isParticipant(get(/databases/$(database)/documents/conversations/$(conversationId)).data) &&
          (resource.data.senderId == request.auth.uid ||
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead', 'readAt', 'read', 'status', 'reactions']));

        // Sender can delete their own messages
        allow delete: if isAuthenticated() &&
          resource.data.senderId == request.auth.uid;
      }
    }

    // ============================================================
    // CALLS COLLECTION (Voice Calls)
    // ============================================================
    match /calls/{callId} {
      // Caller and receiver can read the call
      allow read: if isAuthenticated() &&
        (resource.data.callerId == request.auth.uid ||
         resource.data.receiverId == request.auth.uid);

      // Authenticated users can create calls (must be the caller)
      allow create: if isAuthenticated() &&
        request.resource.data.callerId == request.auth.uid;

      // Caller and receiver can update call state
      allow update: if isAuthenticated() &&
        (resource.data.callerId == request.auth.uid ||
         resource.data.receiverId == request.auth.uid);

      // Caller and receiver can delete call records
      allow delete: if isAuthenticated() &&
        (resource.data.callerId == request.auth.uid ||
         resource.data.receiverId == request.auth.uid);
    }

    // ============================================================
    // CONNECTION REQUESTS COLLECTION
    // ============================================================
    match /connection_requests/{requestId} {
      // Authenticated users can read connection requests
      // (queries already filter by senderId/receiverId in the app)
      allow read: if isAuthenticated();

      // Any authenticated user can create a request (sender must be themselves)
      allow create: if isAuthenticated() &&
        request.resource.data.senderId == request.auth.uid &&
        request.resource.data.senderId != request.resource.data.receiverId;

      // Receiver can update (accept/reject), sender can cancel
      allow update: if isAuthenticated() &&
        (resource.data.receiverId == request.auth.uid ||
         resource.data.senderId == request.auth.uid);

      // Sender or receiver can delete
      allow delete: if isAuthenticated() &&
        (resource.data.senderId == request.auth.uid ||
         resource.data.receiverId == request.auth.uid);
    }

    // ============================================================
    // MATCHES COLLECTION
    // ============================================================
    match /matches/{matchId} {
      // Users can read their matches
      allow read: if isAuthenticated() &&
        (resource.data.user1Id == request.auth.uid ||
         resource.data.user2Id == request.auth.uid ||
         (resource.data.users != null && resource.data.users[request.auth.uid] == true) ||
         (resource.data.userIds != null && request.auth.uid in resource.data.userIds));

      // Users can create matches they're part of
      allow create: if isAuthenticated();

      // Users can update their match status
      allow update: if isAuthenticated() &&
        (resource.data.user1Id == request.auth.uid ||
         resource.data.user2Id == request.auth.uid ||
         (resource.data.users != null && resource.data.users[request.auth.uid] == true) ||
         (resource.data.userIds != null && request.auth.uid in resource.data.userIds));

      allow delete: if isAuthenticated() &&
        (resource.data.user1Id == request.auth.uid ||
         resource.data.user2Id == request.auth.uid);
    }

    // ============================================================
    // BUSINESSES COLLECTION
    // ============================================================
    match /businesses/{businessId} {
      // Anyone authenticated can read businesses
      allow read: if isAuthenticated();

      // Owner can create
      allow create: if isAuthenticated() &&
        request.resource.data.ownerId == request.auth.uid;

      // Owner can update
      allow update: if isAuthenticated() &&
        resource.data.ownerId == request.auth.uid;

      // Owner can delete
      allow delete: if isAuthenticated() &&
        resource.data.ownerId == request.auth.uid;
    }

    // ============================================================
    // BUSINESS LISTINGS COLLECTION
    // ============================================================
    match /business_listings/{listingId} {
      // Anyone authenticated can read listings
      allow read: if isAuthenticated();

      // Business owner can create
      allow create: if isAuthenticated() &&
        request.resource.data.businessOwnerId == request.auth.uid;

      // Business owner can update
      allow update: if isAuthenticated() &&
        resource.data.businessOwnerId == request.auth.uid;

      // Business owner can delete
      allow delete: if isAuthenticated() &&
        resource.data.businessOwnerId == request.auth.uid;
    }

    // ============================================================
    // BUSINESS REVIEWS COLLECTION
    // ============================================================
    match /business_reviews/{reviewId} {
      // Anyone authenticated can read reviews
      allow read: if isAuthenticated();

      // Users can create reviews
      allow create: if isAuthenticated() &&
        request.resource.data.reviewerId == request.auth.uid;

      // Reviewer can update
      allow update: if isAuthenticated() &&
        resource.data.reviewerId == request.auth.uid;

      // Reviewer can delete
      allow delete: if isAuthenticated() &&
        resource.data.reviewerId == request.auth.uid;
    }

    // ============================================================
    // BUSINESS FOLLOWERS COLLECTION
    // ============================================================
    match /business_followers/{followId} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated() &&
        request.resource.data.followerId == request.auth.uid;

      allow delete: if isAuthenticated() &&
        resource.data.followerId == request.auth.uid;
    }

    // ============================================================
    // BLOCKS COLLECTION
    // ============================================================
    match /blocks/{blockId} {
      // Only the blocker can read their blocks
      allow read: if isAuthenticated() &&
        resource.data.blockerId == request.auth.uid;

      // Users can create blocks
      allow create: if isAuthenticated() &&
        request.resource.data.blockerId == request.auth.uid;

      // Users can delete their blocks (unblock)
      allow delete: if isAuthenticated() &&
        resource.data.blockerId == request.auth.uid;

      // Nested blocked_users subcollection (alternative structure)
      match /blocked_users/{blockedId} {
        allow read, write: if isAuthenticated() &&
          blockId == request.auth.uid;
      }
    }

    // ============================================================
    // REPORTS COLLECTION
    // ============================================================
    match /reports/{reportId} {
      // Only reporter can read their own reports
      allow read: if isAuthenticated() &&
        resource.data.reporterId == request.auth.uid;

      // Any authenticated user can create a report
      allow create: if isAuthenticated() &&
        request.resource.data.reporterId == request.auth.uid;

      // Reports cannot be updated or deleted by users
      allow update, delete: if false;
    }

    // ============================================================
    // FEEDBACK COLLECTION
    // ============================================================
    match /feedback/{feedbackId} {
      // Only the submitter can read their feedback
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // Users can submit feedback
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      // Feedback is immutable
      allow update, delete: if false;
    }

    // ============================================================
    // INTENT CLARIFICATIONS COLLECTION (Logging)
    // ============================================================
    match /intent_clarifications/{clarificationId} {
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      allow update, delete: if false; // Logs are immutable
    }

    // ============================================================
    // GROUP CALLS COLLECTION
    // ============================================================
    match /group_calls/{callId} {
      // Participants can read the call
      allow read: if isAuthenticated() &&
        request.auth.uid in resource.data.participants;

      // Any authenticated user can create a call (caller must be themselves)
      allow create: if isAuthenticated() &&
        request.resource.data.callerId == request.auth.uid;

      // Participants and caller can update call state
      allow update: if isAuthenticated() &&
        (resource.data.callerId == request.auth.uid ||
         request.auth.uid in resource.data.participants);

      // Caller can delete call records
      allow delete: if isAuthenticated() &&
        resource.data.callerId == request.auth.uid;

      // Participants subcollection
      match /participants/{participantId} {
        allow read: if isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/group_calls/$(callId)).data.participants;

        allow write: if isAuthenticated() &&
          request.auth.uid == participantId;
      }

      // Signaling subcollection for WebRTC SDP exchange
      match /signaling/{document=**} {
        allow read, write: if isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/group_calls/$(callId)).data.participants;
      }

      // ICE candidates subcollection
      match /ice_candidates/{document=**} {
        allow read, write: if isAuthenticated() &&
          request.auth.uid in get(/databases/$(database)/documents/group_calls/$(callId)).data.participants;
      }
    }

    // ============================================================
    // NOTIFICATIONS COLLECTION
    // ============================================================
    match /notifications/{userId} {
      allow read: if isOwner(userId);
      allow write: if isAuthenticated();

      match /items/{notificationId} {
        allow read: if isOwner(userId);
        allow create: if isAuthenticated();
        allow update, delete: if isOwner(userId);
      }
    }

    // ============================================================
    // USER STATUS/PRESENCE
    // ============================================================
    match /status/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }

    // ============================================================
    // SEARCH INDEX (Server-side only)
    // ============================================================
    match /search_index/{document=**} {
      allow read: if isAuthenticated();
      allow write: if false; // Server-side only
    }

    // ============================================================
    // GLOBAL CONFIG (Read-only)
    // ============================================================
    match /config/{document=**} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // ============================================================
    // DEPRECATED COLLECTIONS (Allow read for migration, deny write)
    // ============================================================

    // Old intents collection - DEPRECATED
    match /intents/{intentId} {
      allow read: if isAuthenticated();
      allow write: if false; // Deprecated - use posts collection
    }

    // Old user_intents collection - DEPRECATED
    match /user_intents/{intentId} {
      allow read: if isAuthenticated();
      allow write: if false; // Deprecated - use posts collection
    }

    // Old processed_intents collection - DEPRECATED
    match /processed_intents/{intentId} {
      allow read: if isAuthenticated();
      allow write: if false; // Deprecated - use posts collection
    }

    // Old embeddings collection - DEPRECATED
    match /embeddings/{embeddingId} {
      allow read: if isAuthenticated();
      allow write: if false; // Deprecated - embeddings stored in posts
    }

    // ============================================================
    // TEMP COLLECTION (For generating IDs)
    // ============================================================
    match /temp/{docId} {
      allow read, write: if isAuthenticated();
    }
  }
}
