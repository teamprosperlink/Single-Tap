================================================================================
                    SingleTap-STYLE LOGOUT - VISUAL FLOW
================================================================================

The complete flow of how Device A automatically logs out when Device B
logs in with the same account.

================================================================================
                          BEFORE THE FIX (BROKEN)
================================================================================

Device B Login Timeline:

0s:   Device B â†’ Enter credentials â†’ Firebase auth succeeds
      â”œâ”€ ALREADY_LOGGED_IN error detected
      â”œâ”€ Save Device B session to Firestore
      â””â”€ Call _automaticallyLogoutOtherDevice()

2.5s: Device B â†’ Send logout signal to Firestore
      â”œâ”€ Write forceLogout=true
      â”œâ”€ Update activeDeviceToken to Device B
      â””â”€ Ready to navigate to app

3s:   Device A â†’ [BROKEN] Listener not restarting!
      â”‚   â”œâ”€ Auth state: Still has same UID ("user123")
      â”‚   â”œâ”€ Check: if (_lastInitializedUserId != uid)
      â”‚   â”œâ”€ Condition: "user123" != "user123" = FALSE
      â”‚   â”œâ”€ Result: Listener code SKIPPED âŒ
      â”‚   â””â”€ Never sees forceLogout=true signal!
      â”‚
      â””â”€ Device A never logs out âŒ

RESULT: Both devices logged in with same account âŒ


================================================================================
                          AFTER THE FIX (WORKING)
================================================================================

Device A's Listener Initialization:

1. [BUILD] User logged in: user123
2. [BUILD] Restarting device session monitoring - checking for new device logins...
3. [BUILD] Subscription BEFORE: (old subscription)
4. Future.delayed(500ms)...
5. [BUILD] Auth verified after delay, starting listener
6. [DeviceSession] âœ… Starting real-time listener
7. [DeviceSession] ğŸ›¡ï¸ PROTECTION WINDOW: 10 seconds
8. [DeviceSession] âœ… Listener ready - protection window now active

DEVICE B LOGIN TIMELINE:

TIME   DEVICE A                          DEVICE B
â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0ms    Using app normally                Enter credentials, click login
100ms                                    Firebase auth succeeds
200ms                                    ALREADY_LOGGED_IN error thrown
250ms                                    Save Device B session to Firestore
300ms                                    _automaticallyLogoutOtherDevice() called
350ms                                    Wait 2.5 seconds for listener init
       âœ“ Listener active (0-10s)         (waiting...)
       [No logout checks yet]
1000ms                                   Still waiting...
2850ms                                   Wait completes
2900ms                                   logoutFromOtherDevices() called
2950ms  â† Listener detects Firestore     Write forceLogout=true â†’ Firestore
        â† change but skips check         Update activeDeviceToken
        (PROTECTION WINDOW 0-10s)        Ready to navigate to app
3000ms  Snapshot received: 3s
        â³ PROTECTION PHASE
        (9-3=6 seconds remaining)
        Skip all logout checks

5000ms  Snapshot: 5s into protection
        Still in protection phase

10000ms Snapshot: 10s since start
        âœ… PROTECTION PHASE COMPLETE
        Now checking forceLogout...

10050ms ğŸ“‹ forceLogout value: true (type: bool)
        ğŸ“‹ forceLogout parsed: true

10100ms ğŸ”´ FORCE LOGOUT SIGNAL DETECTED!
        Call _performRemoteLogout()

10200ms Cancel subscriptions
        Clear state flags

10300ms ğŸ”´ Calling signOut()...
        Sign out from Firebase

10400ms âœ“ Firebase sign out completed
        App detects user=null
        MainNavigationScreen â†’ OnboardingScreen
        âœ“ Shows login screen âœ“

        "You've been logged out from
         another device" âœ“

3200ms                                   Navigate to main app
3300ms                                   âœ“ Shows main app screen âœ“
                                        Ready to use âœ“

RESULT: âœ… Only Device B logged in âœ“


================================================================================
                        PROTECTION WINDOW EXPLAINED
================================================================================

Why Do We Need a 10-Second Protection Window?

Device B writes forceLogout=true at ~3 seconds.
Device A's listener would detect this AND trigger logout on Device A.

BUT... Device B also detects its OWN forceLogout write!

Without protection window:
  - Device B writes forceLogout=true
  - Device B's listener fires
  - Device B sees forceLogout=true
  - Device B logs itself out âŒ

With 10-second protection window:
  - Device B writes forceLogout=true at 3s
  - Device B's listener fires at 3s
  - BUT: We're in protection phase (0-10s)
  - SO: Skip all logout checks for Device B âœ“
  - Result: Device B stays logged in âœ“


Timeline with Protection Window:

Device B Listener:
  0s:   Start â†’ Protection window begins (0-10s)
  3s:   forceLogout=true written
  3.1s: Listener snapshot fires
  3.2s: Check: Are we in protection window (0-10s)? YES
  3.3s: Skip logout check â†’ Device B stays logged in âœ“
  10s:  Protection window ends
  10.1s: Device B can now detect logout signals (but won't because signal was at 3s)

Device A Listener:
  0s:   Start â†’ Protection window begins (0-10s)
  10s:  Protection window ends
  10.1s: Snapshot fires
  10.2s: Check: Are we in protection window? NO
  10.3s: Check forceLogout=true value
  10.4s: DETECTED! Call _performRemoteLogout() âœ“


================================================================================
                    DEVICE TOKEN TRACKING
================================================================================

Firestore users/{userId} Document:

BEFORE Device B Login:
{
  uid: "user123",
  name: "John Doe",
  email: "john@example.com",
  activeDeviceToken: "device-a-token-xxxx",
  forceLogout: false
}

When Device B logs in:
{
  uid: "user123",
  name: "John Doe",
  email: "john@example.com",
  activeDeviceToken: "device-b-token-yyyy",  â† CHANGED!
  forceLogout: true                          â† CHANGED!
}

Device A's listener detects:
  âœ“ activeDeviceToken changed (from device-a-token to device-b-token)
  âœ“ forceLogout changed (from false to true)

â†’ Both changes indicate Device B is now active
â†’ Device A should logout


================================================================================
                      STATE MANAGEMENT
================================================================================

Device A State During Logout:

BEFORE:
  _isPerformingLogout: false
  _hasInitializedServices: true
  _lastInitializedUserId: "user123"
  FirebaseAuth.currentUser: User(uid="user123")
  Widget state: MainNavigationScreen

DURING:
  Snapshot received â†’ forceLogout=true detected
  â†’ _isPerformingLogout: true (prevent re-entry)
  â†’ _performRemoteLogout() called
  â†’ Cancel subscriptions
  â†’ Clear state flags
  â†’ Call signOut()

AFTER:
  _isPerformingLogout: true (stays true)
  _hasInitializedServices: false
  _lastInitializedUserId: null
  FirebaseAuth.currentUser: null
  Widget state: OnboardingScreen (login screen)

StreamBuilder detects auth state change:
  currentUser = null
  â†’ Returns OnboardingScreen
  â†’ User sees login screen âœ“


================================================================================
                      ERROR HANDLING
================================================================================

What if something goes wrong?

Issue: forceLogout signal not received
â”œâ”€ Device A listener not started? â†’ Added 500ms delay + auth verification
â”œâ”€ Firestore listener failed? â†’ onError handler logs and continues
â”œâ”€ Permission denied? â†’ Error logged, user can retry login
â””â”€ Snapshot doesn't exist? â†’ Detect and logout anyway

Issue: Device B doesn't navigate to app
â”œâ”€ Automatic logout called? â†’ Yes, always called
â”œâ”€ Navigation failed? â†’ Handled in error block with snackbar
â”œâ”€ User still logged in Firebase? â†’ Session saved to Firestore
â””â”€ Can retry navigation manually

Issue: Device A detects its own logout during protection window
â”œâ”€ Protection window active? â†’ Yes, 10 seconds
â”œâ”€ Skip logout check? â†’ Yes, skip ALL checks in protection window
â”œâ”€ Device A safe? â†’ Yes, won't logout itself âœ“
â””â”€ When can Device A logout? â†’ Only after 10 seconds (when Device B no longer active)


================================================================================
                    USER EXPERIENCE COMPARISON
================================================================================

SingleTap-STYLE (Current Implementation):

Device A: Using app
Device B: Login
  â†“
Device A: (no notification)
Device B: Loading spinner (no dialog, no waiting)
  â†“
Device A: Gets logout signal â†’ Shows login screen
Device B: Shows main app
  â†“
RESULT: Only Device B logged in âœ“


OLD STYLE (With Dialog - Previous Iteration):

Device A: Using app
Device B: Login
  â†“
Device B: Dialog appears asking what to do
  â”œâ”€ "Logout Other Device"
  â””â”€ "Stay Logged In"
  â†“
User must choose option...
  â†“
Device A & B: Behavior depends on choice
  â†“
RESULT: Confusing UX, user must make decision


================================================================================
                        LOGGING FLOW
================================================================================

Console Output When Testing:

Device B Console:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
I/flutter (12345): [LoginScreen] Starting automatic logout of other device...
I/flutter (12345): [LoginScreen] Waiting 2.5 seconds for listener to initialize...
I/flutter (12345): [LoginScreen] Listener initialized, now logging out other device...
I/flutter (12345): [AuthService] Calling logoutFromOtherDevices
I/flutter (12345): [AuthService] STEP 1: Writing forceLogout=true
I/flutter (12345): [AuthService] âœ“ STEP 1 succeeded
I/flutter (12345): [LoginScreen] âœ“ Other device logout command sent
I/flutter (12345): [LoginScreen] âœ“ Navigating Device B to main app...

Device A Console:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
I/flutter (12346): [BUILD] Restarting device session monitoring - checking for new device logins...
I/flutter (12346): [BUILD] Auth verified after delay, starting listener
I/flutter (12346): [BUILD] Subscription AFTER: Instance...
I/flutter (12346): [DeviceSession] ğŸš€ LISTENER STARTED AT: 2026-01-12 10:00:00.000...
I/flutter (12346): [DeviceSession] âœ… Starting real-time listener
I/flutter (12346): [DeviceSession] âœ… Listener ready - protection window now active
...
I/flutter (12346): [DeviceSession] ğŸ• Snapshot received: 10.5s since listener start
I/flutter (12346): [DeviceSession] âœ… PROTECTION PHASE COMPLETE - NOW checking logout signals
I/flutter (12346): [DeviceSession] ğŸ“‹ forceLogout value: true (type: bool)
I/flutter (12346): [DeviceSession] ğŸ“‹ forceLogout parsed: true
I/flutter (12346): [DeviceSession] ğŸ”´ FORCE LOGOUT SIGNAL DETECTED
I/flutter (12346): [RemoteLogout] ========== REMOTE LOGOUT INITIATED ==========
I/flutter (12346): [RemoteLogout] ğŸ”´ Calling signOut()...
I/flutter (12346): [RemoteLogout] âœ“ Firebase sign out completed


================================================================================
                          SUMMARY
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Device B Logs In                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Detects Existing Session (ALREADY_LOGGED_IN)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Saves Device B Session to Firestore                        â”‚
â”‚ (Device B now logged in but not yet using app)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Calls _automaticallyLogoutOtherDevice()                    â”‚
â”‚ â”œâ”€ Wait 2.5 seconds (listener init)                        â”‚
â”‚ â”œâ”€ Write forceLogout=true to Firestore                     â”‚
â”‚ â””â”€ Update activeDeviceToken to Device B's token            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Device A's Listener Detects Firestore Change               â”‚
â”‚ â”œâ”€ Snapshot received                                       â”‚
â”‚ â”œâ”€ Check: In protection window (0-10s)? YES               â”‚
â”‚ â””â”€ Skip logout check (protected)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Device A: Wait 10 seconds (protection window expires)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Device A's Listener Fires Again                            â”‚
â”‚ â”œâ”€ Check: In protection window? NO                         â”‚
â”‚ â”œâ”€ Check forceLogout value: TRUE                           â”‚
â”‚ â””â”€ ğŸ”´ FORCE LOGOUT SIGNAL DETECTED                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Device A: Sign Out from Firebase                           â”‚
â”‚ â”œâ”€ Cancel subscriptions                                    â”‚
â”‚ â”œâ”€ Clear state flags                                       â”‚
â”‚ â”œâ”€ Call signOut()                                          â”‚
â”‚ â””â”€ StreamBuilder detects: currentUser = null              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Device A: Show Login Screen                                â”‚
â”‚ â””â”€ "You've been logged out from another device"           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                 PARALLEL PROCESS:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Device B: Show Loading Spinner                             â”‚
â”‚ â”œâ”€ No dialog                                               â”‚
â”‚ â”œâ”€ No waiting for user                                     â”‚
â”‚ â””â”€ No user input needed                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Device B: Navigate to Main App                             â”‚
â”‚ â””â”€ Ready to use                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RESULT: âœ… SingleTap-STYLE SINGLE DEVICE LOGIN
  Device A: Logged out
  Device B: Logged in
  Only one device has access âœ“


================================================================================
